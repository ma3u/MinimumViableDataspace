#
#  Copyright (c) 2025 Health Dataspace Demo - EHR2EDC
#
#  This program and the accompanying materials are made available under the
#  terms of the Apache License, Version 2.0 which is available at
#  https://www.apache.org/licenses/LICENSE-2.0
#
#  SPDX-License-Identifier: Apache-2.0
#

services:
  # Health Dataspace Frontend (EHR2EDC)
  health-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_MODE=full
    container_name: health-frontend
    ports:
      - "3000:80"
    depends_on:
      - ehr-backend
    networks:
      - health-network
    restart: unless-stopped

  # EHR Backend Mock Service (Rheinland Universit√§tsklinikum data)
  ehr-backend:
    build:
      context: ./backend-mock
      dockerfile: Dockerfile
    container_name: ehr-backend
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      # OpenTelemetry tracing configuration
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tools-jaeger:4318/v1/traces
      - OTEL_SERVICE_NAME=ehr-backend
      - OTEL_TRACES_EXPORTER=otlp
    networks:
      - health-network
    restart: unless-stopped

  # HealthDCAT-AP Editor (Interoperability Test Bed SHACL Validator)
  healthdcatap-editor:
    image: isaitb/shacl-validator:latest
    container_name: healthdcatap-editor
    ports:
      - "8880:8080"   # Changed from 8082 to avoid conflict with EDC DSP API
    networks:
      - health-network
    restart: unless-stopped

networks:
  health-network:
    driver: bridge

# Note: This docker-compose is for the Health/EHR2EDC demo components.
# The MVD infrastructure (EDC connectors, IdentityHubs, etc.) should be 
# started separately using the IntelliJ run configs or Kubernetes deployment.
#
# To use with IntelliJ deployment:
#   1. Start NGINX for issuer DID
#   2. Start the 'dataspace' compound run config in IntelliJ
#   3. Run the unified seeding script:
#      ./seed-dataspace.sh --mode=local
#   4. For Docker-mode seed (if needed):
#      ./seed-dataspace.sh --mode=docker
#   5. docker-compose -f docker-compose.health.yml up --build
#   6. Open http://localhost:3000
#   7. HealthDCAT-AP Editor available at http://localhost:8082
#
# For standalone development (frontend only):
#   cd frontend && npm install && npm run dev
