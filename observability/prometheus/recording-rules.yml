# Prometheus Recording Rules for Health Dataspace
#
# Pre-computed metrics for dashboard performance and consistency.
# These rules run every 15s and create new time series.
#
# Categories:
# 1. HTTP Request Metrics (5 rules)
# 2. EDC/Dataspace Metrics (5 rules)
# 3. EHDS Compliance Metrics (5 rules)
# 4. Resource Utilization Metrics (5 rules)
#

groups:
  # ============================================================
  # Group 1: HTTP Request Metrics
  # ============================================================
  - name: http_request_metrics
    interval: 15s
    rules:
      # Rule 1: Request rate per service (5m average)
      - record: job:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (job)
        labels:
          category: "http"

      # Rule 2: Request rate by status code
      - record: job:http_requests_by_status:rate5m
        expr: sum(rate(http_requests_total[5m])) by (job, status_code)
        labels:
          category: "http"

      # Rule 3: Error rate percentage
      - record: job:http_error_rate:ratio5m
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (job) /
          sum(rate(http_requests_total[5m])) by (job)
        labels:
          category: "http"

      # Rule 4: P95 latency per endpoint
      - record: job:http_request_duration_p95:5m
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))
        labels:
          category: "http"

      # Rule 5: Request throughput (requests per second)
      - record: job:http_throughput:rate1m
        expr: sum(rate(http_requests_total[1m])) by (job)
        labels:
          category: "http"

  # ============================================================
  # Group 2: EDC/Dataspace Metrics
  # ============================================================
  - name: edc_dataspace_metrics
    interval: 15s
    rules:
      # Rule 6: Contract negotiation rate
      - record: edc:contract_negotiations:rate5m
        expr: sum(rate(contract_negotiations_total[5m])) by (status)
        labels:
          category: "edc"

      # Rule 7: Contract negotiation success ratio
      - record: edc:contract_success:ratio5m
        expr: |
          sum(rate(contract_negotiations_total{status="completed"}[5m])) /
          sum(rate(contract_negotiations_total[5m]))
        labels:
          category: "edc"

      # Rule 8: Asset transfer rate
      - record: edc:asset_transfers:rate5m
        expr: sum(rate(asset_transfers_total[5m])) by (status)
        labels:
          category: "edc"

      # Rule 9: Active negotiations gauge
      - record: edc:active_negotiations:current
        expr: sum(active_negotiations)
        labels:
          category: "edc"

      # Rule 10: Data exchange volume (if available)
      - record: edc:data_exchange:rate5m
        expr: sum(rate(data_exchange_bytes_total[5m]))
        labels:
          category: "edc"

  # ============================================================
  # Group 3: EHDS Compliance Metrics
  # ============================================================
  - name: ehds_compliance_metrics
    interval: 15s
    rules:
      # Rule 11: Consent verification rate
      - record: ehds:consent_requests:rate5m
        expr: sum(rate(ehds_consent_requests_total[5m])) by (status)
        labels:
          category: "ehds"

      # Rule 12: Consent approval ratio
      - record: ehds:consent_approval:ratio5m
        expr: |
          sum(rate(ehds_consent_requests_total{status="approved"}[5m])) /
          sum(rate(ehds_consent_requests_total[5m]))
        labels:
          category: "ehds"

      # Rule 13: Data access by type rate
      - record: ehds:data_access_by_type:rate5m
        expr: sum(rate(data_access_total[5m])) by (access_type)
        labels:
          category: "ehds"

      # Rule 14: Data access by category rate
      - record: ehds:data_access_by_category:rate5m
        expr: sum(rate(data_access_total[5m])) by (data_category)
        labels:
          category: "ehds"

      # Rule 15: Data access by purpose rate
      - record: ehds:data_access_by_purpose:rate5m
        expr: sum(rate(data_access_total[5m])) by (purpose)
        labels:
          category: "ehds"

  # ============================================================
  # Group 4: Resource Utilization Metrics
  # ============================================================
  - name: resource_utilization_metrics
    interval: 15s
    rules:
      # Rule 16: Container CPU usage percentage
      - record: container:cpu_usage:percent
        expr: |
          sum(rate(container_cpu_usage_seconds_total{name=~".+"}[5m])) by (name) * 100
        labels:
          category: "resource"

      # Rule 17: Container memory usage percentage
      - record: container:memory_usage:percent
        expr: |
          sum(container_memory_usage_bytes{name=~".+"}) by (name) /
          sum(container_spec_memory_limit_bytes{name=~".+"}) by (name) * 100
        labels:
          category: "resource"

      # Rule 18: Container network receive rate
      - record: container:network_receive:rate5m
        expr: sum(rate(container_network_receive_bytes_total{name=~".+"}[5m])) by (name)
        labels:
          category: "resource"

      # Rule 19: Container network transmit rate
      - record: container:network_transmit:rate5m
        expr: sum(rate(container_network_transmit_bytes_total{name=~".+"}[5m])) by (name)
        labels:
          category: "resource"

      # Rule 20: Total running containers
      - record: cluster:containers:running
        expr: count(container_last_seen{name=~".+"})
        labels:
          category: "resource"

  # ============================================================
  # Additional Business Metrics
  # ============================================================
  - name: business_metrics
    interval: 30s
    rules:
      # Catalog query success rate
      - record: catalog:queries:success_ratio5m
        expr: |
          sum(rate(catalog_queries_total{status="success"}[5m])) /
          sum(rate(catalog_queries_total[5m]))
        labels:
          category: "business"

      # EHR record access rate
      - record: ehr:records_accessed:rate5m
        expr: sum(rate(ehr_records_accessed_total[5m])) by (record_type)
        labels:
          category: "business"

      # Policy evaluation success rate
      - record: policy:evaluations:success_ratio5m
        expr: |
          sum(rate(policy_evaluations_total{result="permit"}[5m])) /
          sum(rate(policy_evaluations_total[5m]))
        labels:
          category: "business"

      # Average data access by role
      - record: ehds:access_by_role:rate5m
        expr: sum(rate(data_access_total[5m])) by (user_role)
        labels:
          category: "business"

      # Overall system health score (composite)
      - record: system:health_score:current
        expr: |
          (
            (1 - clamp_max(sum(rate(http_requests_total{status_code=~"5.."}[5m])) / sum(rate(http_requests_total[5m])), 1)) * 0.4 +
            clamp_max(sum(rate(contract_negotiations_total{status="completed"}[5m])) / sum(rate(contract_negotiations_total[5m])), 1) * 0.3 +
            clamp_max(sum(rate(ehds_consent_requests_total{status="approved"}[5m])) / sum(rate(ehds_consent_requests_total[5m])), 1) * 0.3
          ) * 100
        labels:
          category: "business"

  # ============================================================
  # Group 5: PromQL Reference Queries (from IMPLEMENTATION_PLAN.md 14.10)
  # Pre-computed for Prometheus UI "Explore" and quick access
  # ============================================================
  - name: promql_reference_queries
    interval: 15s
    rules:
      # EDC Flow Metrics (1-3)
      
      # Query 1: Contract Negotiations by Status
      - record: dashboard:contract_negotiations:by_status
        expr: sum by (status) (contract_negotiations_total)
        labels:
          category: "dashboard"
          query_id: "1"
          description: "Contract Negotiations by Status"

      # Query 2: Asset Transfer Success Rate (%)
      - record: dashboard:asset_transfer:success_rate
        expr: sum(asset_transfers_total{status="completed"}) / sum(asset_transfers_total) * 100
        labels:
          category: "dashboard"
          query_id: "2"
          description: "Asset Transfer Success Rate"

      # Query 3: Catalog Query Rate (per minute)
      - record: dashboard:catalog_queries:rate_per_min
        expr: rate(catalog_queries_total[5m]) * 60
        labels:
          category: "dashboard"
          query_id: "3"
          description: "Catalog Query Rate per Minute"

      # EHDS Consent Metrics (4-6)

      # Query 4: EHDS Consent Requests by Status
      - record: dashboard:ehds_consent:by_status
        expr: sum by (status) (ehds_consent_requests_total)
        labels:
          category: "dashboard"
          query_id: "4"
          description: "EHDS Consent Requests by Status"

      # Query 5: Consent Approval Rate (%)
      - record: dashboard:consent:approval_rate
        expr: sum(ehds_consent_requests_total{status="approved"}) / sum(ehds_consent_requests_total) * 100
        labels:
          category: "dashboard"
          query_id: "5"
          description: "Consent Approval Rate"

      # Query 6: EHR Records Accessed by Type
      - record: dashboard:ehr_records:by_type
        expr: sum by (record_type) (ehr_records_accessed_total)
        labels:
          category: "dashboard"
          query_id: "6"
          description: "EHR Records Accessed by Type"

      # Service Health Metrics (7-10)

      # Query 7: All Services Status (up/down)
      - record: dashboard:services:status
        expr: up
        labels:
          category: "dashboard"
          query_id: "7"
          description: "All Services Status"

      # Query 8: HTTP Request Rate per Service
      - record: dashboard:http_requests:rate_by_job
        expr: sum by (job) (rate(http_requests_total[5m]))
        labels:
          category: "dashboard"
          query_id: "8"
          description: "HTTP Request Rate per Service"

      # Query 9: Data Access by User Role
      - record: dashboard:data_access:by_role
        expr: sum by (user_role) (data_access_total)
        labels:
          category: "dashboard"
          query_id: "9"
          description: "Data Access by User Role"

      # Query 10: Active Transfers
      - record: dashboard:active_transfers:current
        expr: active_transfers
        labels:
          category: "dashboard"
          query_id: "10"
          description: "Currently Active Transfers"
