# =============================================================================
# EDC-MVD-HealthDemo - Health Dataspace EHR2EDC Demonstration
# =============================================================================
# 
# This docker-compose deploys a complete health dataspace demonstration:
#
# PARTICIPANTS:
#   - Hospital (Provider): Rheinland Universitätsklinikum - provides EHR data
#   - Research Institute (Consumer): Nordstein Research Institute - consumes EHR for EDC
#
# COMPONENTS:
#   - Infrastructure: PostgreSQL, Vault, NGINX (DID server)
#   - EDC Connectors: Control planes, data planes, identity hubs
#   - Application Layer: EHR Backend (FHIR), Health Frontend (React)
#
# QUICK START:
#   docker compose -p edc-mvd-health up -d health-postgres health-vault
#   docker compose -p edc-mvd-health up -d ehr-backend health-frontend
#
# =============================================================================

name: edc-mvd-health

services:
  # ===========================================================================
  # INFRASTRUCTURE LAYER
  # ===========================================================================
  health-postgres:
    image: postgres:16
    container_name: health-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: password
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - health-dataspace

  health-vault:
    image: hashicorp/vault:latest
    container_name: health-vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    networks:
      - health-dataspace

  health-did-server:
    image: nginx
    container_name: health-did-server
    ports:
      - "9876:80"
    volumes:
      - ./assets/issuer/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./assets/issuer/did.docker.json:/var/www/.well-known/did.json:ro
    networks:
      - health-dataspace

  # ===========================================================================
  # CONSUMER: Nordstein Research Institute (CRO)
  # Consumes anonymized EHR data for clinical research EDC systems
  # ===========================================================================
  cro-controlplane:
    image: controlplane:latest
    container_name: cro-controlplane
    env_file:
      - ./assets/env/consumer_connector.env
    environment:
      # DB Configuration
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/consumer
      EDC_DATASOURCE_DEFAULT_USER: consumer
      EDC_DATASOURCE_DEFAULT_PASSWORD: consumer
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      # Vault Configuration
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    volumes:
      - ./assets/participants:/app/deployment/assets/participants:ro
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"
      - "8083:8083"
      - "8084:8084"
      - "8085:8085"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  cro-dataplane:
    image: dataplane:latest
    container_name: cro-dataplane
    env_file:
      - ./assets/env/consumer_connector.env
    environment:
      EDC_RUNTIME_ID: cro-dataplane
      # Port Overrides
      WEB_HTTP_PORT: 9080
      WEB_HTTP_CONTROL_PORT: 9083
      WEB_HTTP_PUBLIC_PORT: 11001
      # DB Configuration
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/consumer
      EDC_DATASOURCE_DEFAULT_USER: consumer
      EDC_DATASOURCE_DEFAULT_PASSWORD: consumer
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      # Vault Configuration
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
      # Hostname
      EDC_HOSTNAME: localhost
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "11000:9080" # Web/Health
      - "11002:9083" # Control
      - "11001:11001" # Public
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  cro-identityhub:
    image: identity-hub:latest
    container_name: cro-identityhub
    env_file:
      - ./assets/env/consumer_identityhub.env
    environment:
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/consumer
      EDC_DATASOURCE_DEFAULT_USER: consumer
      EDC_DATASOURCE_DEFAULT_PASSWORD: consumer
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "7080:7080"
      - "7081:7081"
      - "7082:7082"
      - "7083:7083"
      - "7085:7085"
      - "7086:7086"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  # ===========================================================================
  # PROVIDER: Rheinland Universitätsklinikum (Hospital)
  # Provides de-identified EHR data following GDPR/EHDS regulations
  # ===========================================================================
  hospital-identityhub:
    image: identity-hub:latest
    container_name: hospital-identityhub
    env_file:
      - ./assets/env/provider_identityhub.env
    environment:
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/identity
      EDC_DATASOURCE_DEFAULT_USER: identity
      EDC_DATASOURCE_DEFAULT_PASSWORD: identity
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "7090:7090"
      - "7091:7091"
      - "7092:7092"
      - "7093:7093"
      - "7095:7095"
      - "7096:7096"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  hospital-catalog-server:
    image: catalog-server:latest
    container_name: hospital-catalog-server
    env_file:
      - ./assets/env/provider_catalogserver.env
    environment:
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/catalog_server
      EDC_DATASOURCE_DEFAULT_USER: catalog_server
      EDC_DATASOURCE_DEFAULT_PASSWORD: catalog_server
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    volumes:
      - ./assets/participants:/app/deployment/assets/participants:ro
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "8090:8090"
      - "8091:8091"
      - "8092:8092"
      - "8093:8093"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  # Hospital EHR Department Connector
  hospital-ehr-controlplane:
    image: controlplane:latest
    container_name: hospital-ehr-controlplane
    env_file:
      - ./assets/env/provider_connector_qna.env
    environment:
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/provider_qna
      EDC_DATASOURCE_DEFAULT_USER: qna
      EDC_DATASOURCE_DEFAULT_PASSWORD: provider-qna
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "8190:8190"
      - "8191:8191"
      - "8192:8192"
      - "8193:8193"
      - "8194:8194"
      - "8195:8195"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  hospital-ehr-dataplane:
    image: dataplane:latest
    container_name: hospital-ehr-dataplane
    env_file:
      - ./assets/env/provider_connector_qna.env
    environment:
      EDC_RUNTIME_ID: hospital-ehr-dataplane
      WEB_HTTP_PORT: 9080
      WEB_HTTP_CONTROL_PORT: 9083
      WEB_HTTP_PUBLIC_PORT: 12001
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/provider_qna
      EDC_DATASOURCE_DEFAULT_USER: qna
      EDC_DATASOURCE_DEFAULT_PASSWORD: provider-qna
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
      EDC_HOSTNAME: localhost
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "12000:9080" # Web/Health
      - "12003:9083" # Control
      - "12001:12001" # Public
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  # ===========================================================================
  # HOSPITAL CLINICAL TRIALS DEPARTMENT (Optional secondary connector)
  # For hospitals that need separate consent flows for clinical trials vs EHR
  # ===========================================================================
  # Disabled by default - uncomment to enable separate clinical trials connector
  # hospital-trials-controlplane:
  #   image: controlplane:latest
  #   container_name: hospital-trials-controlplane
  #   env_file:
  #     - ./assets/env/provider_connector_manufacturing.env
  #   environment:
  #     EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/provider_manufacturing
  #     EDC_DATASOURCE_DEFAULT_USER: manufacturing
  #     EDC_DATASOURCE_DEFAULT_PASSWORD: provider-manufacturing
  #     EDC_SQL_SCHEMA_AUTOCREATE: "true"
  #     EDC_VAULT_HASHICORP_URL: http://health-vault:8200
  #     EDC_VAULT_HASHICORP_TOKEN: root
  #   extra_hosts:
  #     - "localhost:host-gateway"
  #   ports:
  #     - "8290:8290"
  #     - "8291:8291"
  #     - "8292:8292"
  #     - "8293:8293"
  #     - "8294:8294"
  #     - "8295:8295"
  #   networks:
  #     - health-dataspace
  #   depends_on:
  #     - health-postgres
  #     - health-vault

  # hospital-trials-dataplane:
  #   image: dataplane:latest
  #   container_name: hospital-trials-dataplane
  #   env_file:
  #     - ./assets/env/provider_connector_manufacturing.env
  #   environment:
  #     EDC_RUNTIME_ID: hospital-trials-dataplane
  #     WEB_HTTP_PORT: 9080
  #     WEB_HTTP_CONTROL_PORT: 9083
  #     WEB_HTTP_PUBLIC_PORT: 12002
  #     EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/provider_manufacturing
  #     EDC_DATASOURCE_DEFAULT_USER: manufacturing
  #     EDC_DATASOURCE_DEFAULT_PASSWORD: provider-manufacturing
  #     EDC_SQL_SCHEMA_AUTOCREATE: "true"
  #     EDC_VAULT_HASHICORP_URL: http://health-vault:8200
  #     EDC_VAULT_HASHICORP_TOKEN: root
  #     EDC_HOSTNAME: localhost
  #   extra_hosts:
  #     - "localhost:host-gateway"
  #   ports:
  #     - "12005:9080" # Web/Health
  #     - "12006:9083" # Control
  #     - "12002:12002" # Public
  #   networks:
  #     - health-dataspace
  #   depends_on:
  #     - health-postgres
  #     - health-vault

  # ===========================================================================
  # TRUST ANCHOR: Health Data Authority Issuer
  # Issues verifiable credentials for health dataspace membership
  # ===========================================================================
  health-authority-issuer:
    image: issuerservice:latest
    container_name: health-authority-issuer
    env_file:
      - ./assets/env/issuerservice.env
    environment:
      EDC_DATASOURCE_DEFAULT_URL: jdbc:postgresql://health-postgres:5432/issuer
      EDC_DATASOURCE_DEFAULT_USER: issuer
      EDC_DATASOURCE_DEFAULT_PASSWORD: issuer
      EDC_SQL_SCHEMA_AUTOCREATE: "true"
      EDC_VAULT_HASHICORP_URL: http://health-vault:8200
      EDC_VAULT_HASHICORP_TOKEN: root
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "10010:10010"
      - "10011:10011"
      - "10012:10012"
      - "10013:10013"
      - "10014:10014"
      - "10015:10015"
    networks:
      - health-dataspace
    depends_on:
      - health-postgres
      - health-vault

  # ===========================================================================
  # APPLICATION LAYER: EHR2EDC Demo Frontend & Backend
  # ===========================================================================
  ehr-backend:
    build:
      context: ../backend-mock
      dockerfile: Dockerfile
    image: health-ehr-backend:latest
    container_name: ehr-backend
    ports:
      - "3003:3001"  # Host 3003 -> Container 3001
    networks:
      - health-dataspace
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  health-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    image: health-ehr2edc-frontend:latest
    container_name: health-frontend
    ports:
      - "3010:80"  # Host 3010 -> Container 80 (nginx)
    networks:
      - health-dataspace
    depends_on:
      ehr-backend:
        condition: service_healthy
      # Note: EDC services are optional - frontend degrades gracefully
      # cro-controlplane:
      #   condition: service_started
      # hospital-ehr-controlplane:
      #   condition: service_started

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
networks:
  health-dataspace:
    name: health-dataspace
    driver: bridge
