---
apiVersion: v1
kind: Service
metadata:
  name: hospital-ehr-dataplane
  namespace: health-dataspace
  labels:
    app: hospital-ehr-dataplane
    component: edc
    role: dataplane
spec:
  type: ClusterIP
  selector:
    app: hospital-ehr-dataplane
  ports:
    - name: web
      port: 9080
      targetPort: 9080
      protocol: TCP
    - name: control
      port: 9083
      targetPort: 9083
      protocol: TCP
    - name: public
      port: 12001
      targetPort: 12001
      protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hospital-ehr-dataplane
  namespace: health-dataspace
  labels:
    app: hospital-ehr-dataplane
    component: edc
    role: dataplane
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hospital-ehr-dataplane
  template:
    metadata:
      labels:
        app: hospital-ehr-dataplane
        component: edc
        role: dataplane
    spec:
      containers:
        - name: dataplane
          image: dataplane:latest
          imagePullPolicy: Never
          ports:
            - name: web
              containerPort: 9080
            - name: control
              containerPort: 9083
            - name: public
              containerPort: 12001
          envFrom:
            - configMapRef:
                name: provider-controlplane-env
          env:
            - name: EDC_RUNTIME_ID
              value: "hospital-ehr-dataplane"
            - name: WEB_HTTP_PORT
              value: "9080"
            - name: WEB_HTTP_CONTROL_PORT
              value: "9083"
            - name: WEB_HTTP_PUBLIC_PORT
              value: "12001"
            - name: EDC_DATASOURCE_DEFAULT_URL
              value: "jdbc:postgresql://health-postgres:5432/provider_qna"
            - name: EDC_DATASOURCE_DEFAULT_USER
              value: "qna"
            - name: EDC_DATASOURCE_DEFAULT_PASSWORD
              value: "provider-qna"
            - name: EDC_SQL_SCHEMA_AUTOCREATE
              value: "true"
            - name: EDC_VAULT_HASHICORP_URL
              value: "http://health-vault:8200"
            - name: EDC_VAULT_HASHICORP_TOKEN
              value: "root"
            - name: EDC_HOSTNAME
              value: "hospital-ehr-dataplane"
          livenessProbe:
            httpGet:
              path: /api/check/liveness
              port: 9080
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/check/readiness
              port: 9080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
      restartPolicy: Always
